// ============================================
// Ascension Example: Try/Catch
// Gestione degli errori
// ============================================

print("=== TRY/CATCH - GESTIONE ERRORI ===\n");

// -----------------------------------------
// TRY/CATCH BASE
// -----------------------------------------
print("--- Esempio Base ---");

try {
    print("Dentro il blocco try");
    x = 10;
    y = 0;
    // Questa operazione potrebbe fallire
    risultato = x / y;
    print("Risultato: " + risultato);
} catch {
    print("ERRORE CATTURATO: divisione per zero!");
}

print("Programma continua dopo il catch\n");

// -----------------------------------------
// VALIDAZIONE INPUT
// -----------------------------------------
print("--- Validazione Input ---");

func parse_int_safe(valore) {
    risultato = 0;
    try {
        risultato = int(valore);
    } catch {
        print("Errore: '" + valore + "' non e' un numero valido");
        risultato = -1;
    }
    return risultato;
}

print("Parse '42': " + parse_int_safe("42"));
print("Parse 'abc': " + parse_int_safe("abc"));
print("Parse '3.14': " + parse_int_safe("3.14"));

// -----------------------------------------
// FILE I/O CON GESTIONE ERRORI
// -----------------------------------------
print("\n--- File I/O Sicuro ---");

func read_file_safe(filename) {
    contenuto = "";
    try {
        handle = file_open(filename, "r");
        if (handle == NULL) {
            throw "File non trovato";
        }
        contenuto = file_readall(handle);
        file_close(handle);
    } catch {
        print("Errore lettura file: " + filename);
        contenuto = "";
    }
    return contenuto;
}

// Test con file esistente
file_test = file_open("test_try.txt", "w");
file_write(file_test, "Contenuto di test");
file_close(file_test);

print("Lettura file esistente:");
print(read_file_safe("test_try.txt"));

print("Lettura file inesistente:");
print(read_file_safe("file_che_non_esiste.xyz"));

// -----------------------------------------
// THROW MANUALE
// -----------------------------------------
print("\n--- Throw Manuale ---");

func divide(a, b) {
    if (b == 0) {
        throw "Divisione per zero non permessa";
    }
    return a / b;
}

func safe_divide(a, b) {
    risultato = 0;
    try {
        risultato = divide(a, b);
        print(a + " / " + b + " = " + risultato);
    } catch {
        print("Errore: impossibile dividere " + a + " per " + b);
    }
    return risultato;
}

safe_divide(10, 2);
safe_divide(15, 3);
safe_divide(8, 0);
safe_divide(100, 4);

// -----------------------------------------
// TRY ANNIDATI
// -----------------------------------------
print("\n--- Try Annidati ---");

func operazione_rischiosa(livello) {
    try {
        print("Livello " + livello + ": inizio");
        if (livello > 0) {
            operazione_rischiosa(livello - 1);
        } else {
            throw "Errore al livello 0!";
        }
        print("Livello " + livello + ": completato");
    } catch {
        print("Livello " + livello + ": errore catturato, gestito");
    }
}

operazione_rischiosa(3);

// -----------------------------------------
// PATTERN: RISORSA SICURA
// -----------------------------------------
print("\n--- Pattern Risorsa Sicura ---");

func with_file(filename, mode, callback_name) {
    handle = NULL;
    try {
        handle = file_open(filename, mode);
        if (handle == NULL) {
            throw "Impossibile aprire file";
        }
        // Qui chiameremmo il callback... 
        // Ma per semplicita' facciamo operazioni dirette
        if (mode == "w") {
            file_write(handle, "Dati scritti in modo sicuro\n");
        } else {
            contenuto = file_readall(handle);
            print("Letto: " + contenuto);
        }
    } catch {
        print("Errore durante operazione su file");
    }
    // Cleanup garantito
    if (handle != NULL) {
        file_close(handle);
        print("File chiuso correttamente");
    }
}

with_file("safe_file.txt", "w", "");
with_file("safe_file.txt", "r", "");

// -----------------------------------------
// CATENA DI OPERAZIONI
// -----------------------------------------
print("\n--- Catena di Operazioni ---");

func step1() {
    print("Step 1: inizializzazione");
    return 10;
}

func step2(val) {
    print("Step 2: elaborazione");
    if (val < 5) {
        throw "Valore troppo basso";
    }
    return val * 2;
}

func step3(val) {
    print("Step 3: finalizzazione");
    return val + 5;
}

func pipeline(start_val) {
    risultato = 0;
    try {
        v1 = step1();
        v2 = step2(start_val);
        v3 = step3(v2);
        risultato = v3;
        print("Pipeline completata con successo!");
    } catch {
        print("Pipeline fallita!");
        risultato = -1;
    }
    return risultato;
}

print("Pipeline con 10:");
print("Risultato: " + pipeline(10));

print("\nPipeline con 3:");
print("Risultato: " + pipeline(3));

print("\n=== FINE ESEMPIO ===");
