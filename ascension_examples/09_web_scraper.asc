// ============================================
// Ascension Example: Web Scraper
// Scarica pagine web ed estrae contenuti
// ============================================

print("=== WEB SCRAPER ===\n");

// -----------------------------------------
// FUNZIONI STRINGA (non built-in)
// -----------------------------------------

// Trova posizione di una sottostringa
func find(testo, cerca) {
    testo_len = len(testo);
    cerca_len = len(cerca);
    
    if (cerca_len > testo_len) {
        return -1;
    }
    
    i = 0;
    while (i <= testo_len - cerca_len) {
        found = true;
        j = 0;
        while (j < cerca_len) {
            if (testo[i + j] != cerca[j]) {
                found = false;
                break;
            }
            j = j + 1;
        }
        if (found) {
            return i;
        }
        i = i + 1;
    }
    return -1;
}

// Trova posizione partendo da un offset
func find_from(testo, cerca, start) {
    testo_len = len(testo);
    cerca_len = len(cerca);
    
    if (start + cerca_len > testo_len) {
        return -1;
    }
    
    i = start;
    while (i <= testo_len - cerca_len) {
        found = true;
        j = 0;
        while (j < cerca_len) {
            if (testo[i + j] != cerca[j]) {
                found = false;
                break;
            }
            j = j + 1;
        }
        if (found) {
            return i;
        }
        i = i + 1;
    }
    return -1;
}

// -----------------------------------------
// FUNZIONI SCRAPING
// -----------------------------------------

// Estrae contenuto tra due tag
func extract_tag(html, open_tag, close_tag) {
    start = find(html, open_tag);
    if (start == -1) {
        return "";
    }
    
    content_start = start + len(open_tag);
    end = find_from(html, close_tag, content_start);
    
    if (end == -1) {
        return "";
    }
    
    return substr(html, content_start, end - content_start);
}

// Estrae contenuto fino al prossimo tag <
func extract_until_tag(html, open_tag) {
    start = find(html, open_tag);
    if (start == -1) {
        return "";
    }
    
    content_start = start + len(open_tag);
    end = find_from(html, "<", content_start);
    
    if (end == -1) {
        return "";
    }
    
    return substr(html, content_start, end - content_start);
}

// Estrae href da link
func extract_href(html) {
    start = find(html, "href=\"");
    if (start == -1) {
        return "";
    }
    
    content_start = start + 6;
    end = find_from(html, "\"", content_start);
    
    if (end == -1) {
        return "";
    }
    
    return substr(html, content_start, end - content_start);
}

// Conta occorrenze di un tag
func count_tags(html, tag) {
    count = 0;
    pos = 0;
    while (pos < len(html)) {
        found = find_from(html, tag, pos);
        if (found == -1) {
            break;
        }
        count = count + 1;
        pos = found + 1;
    }
    return count;
}

// -----------------------------------------
// MAIN SCRAPER
// -----------------------------------------

func scrape(url) {
    print("URL: " + url);
    print("Downloading...\n");
    
    response = http_get(url);
    
    if (response == NULL) {
        print("ERRORE: Download fallito!");
        return;
    }
    
    if (response.status != 200) {
        print("ERRORE: HTTP Status ");
        print(response.status);
        return;
    }
    
    html = response.body;
    print("Ricevuti bytes: ");
    print(len(html));
    
    // Estrai informazioni
    print("\n--- RISULTATI SCRAPING ---\n");
    
    // Title
    title = extract_tag(html, "<title>", "</title>");
    print("TITLE: " + title);
    
    // H1
    h1 = extract_tag(html, "<h1>", "</h1>");
    if (h1 != "") {
        print("H1: " + h1);
    }
    
    // Primo paragrafo
    p = extract_tag(html, "<p>", "</p>");
    if (p == "") {
        p = extract_until_tag(html, "<p>");
    }
    if (p != "") {
        print("PRIMO PARAGRAFO: " + p);
    }
    
    // Primo link
    link = extract_href(html);
    if (link != "") {
        print("PRIMO LINK: " + link);
    }
    
    // Statistiche
    print("\n--- STATISTICHE ---");
    print("Tag <p>: ");
    print(count_tags(html, "<p"));
    print("Tag <a>: ");
    print(count_tags(html, "<a"));
    print("Tag <div>: ");
    print(count_tags(html, "<div"));
}

// -----------------------------------------
// ESECUZIONE
// -----------------------------------------

scrape("http://example.com");

print("\n=== SCRAPING COMPLETATO ===");
