// ============================================
// Ascension Example: Calcolatrice Interattiva
// Una calcolatrice da linea di comando
// ============================================

print("=== CALCOLATRICE ASCENSION ===\n");
print("Operazioni: +, -, *, /, %, ^");
print("Funzioni: sqrt, abs, fact");
print("Digita 'quit' per uscire\n");

// -----------------------------------------
// FUNZIONI MATEMATICHE
// -----------------------------------------

func potenza(base, exp) {
    if (exp == 0) {
        return 1;
    }
    result = 1;
    i = 0;
    while (i < exp) {
        result = result * base;
        i = i + 1;
    }
    return result;
}

func fattoriale(n) {
    if (n <= 1) {
        return 1;
    }
    result = 1;
    i = 2;
    while (i <= n) {
        result = result * i;
        i = i + 1;
    }
    return result;
}

func valore_assoluto(n) {
    if (n < 0) {
        return 0 - n;
    }
    return n;
}

// Radice quadrata approssimata (metodo babilonese)
func radice_quadrata(n) {
    if (n < 0) {
        return -1;
    }
    if (n == 0) {
        return 0;
    }
    
    x = n;
    i = 0;
    while (i < 20) {
        x = (x + n / x) / 2;
        i = i + 1;
    }
    return x;
}

// -----------------------------------------
// FUNZIONI STRINGA HELPER
// -----------------------------------------

func str_find(testo, cerca) {
    testo_len = len(testo);
    cerca_len = len(cerca);
    if (cerca_len > testo_len) {
        return -1;
    }
    i = 0;
    while (i <= testo_len - cerca_len) {
        found = true;
        j = 0;
        while (j < cerca_len) {
            if (testo[i + j] != cerca[j]) {
                found = false;
                break;
            }
            j = j + 1;
        }
        if (found) {
            return i;
        }
        i = i + 1;
    }
    return -1;
}

func str_trim(testo) {
    start = 0;
    while (start < len(testo) && testo[start] == " ") {
        start = start + 1;
    }
    end_pos = len(testo) - 1;
    while (end_pos >= 0 && testo[end_pos] == " ") {
        end_pos = end_pos - 1;
    }
    if (start > end_pos) {
        return "";
    }
    return substr(testo, start, end_pos - start + 1);
}

// Trova l'ultima occorrenza di un carattere nella stringa
func find_last_char(s, ch) {
    i = len(s) - 1;
    while (i >= 0) {
        if (substr(s, i, 1) == ch) {
            return i;
        }
        i = i - 1;
    }
    return -1;
}

// Trova l'ultima occorrenza di + o - (non all'inizio)
func find_last_add_sub(s) {
    i = len(s) - 1;
    while (i > 0) {
        ch = substr(s, i, 1);
        if (ch == "+" || ch == "-") {
            return i;
        }
        i = i - 1;
    }
    return -1;
}

// Trova l'ultima occorrenza di * o /
func find_last_mul_div(s) {
    i = len(s) - 1;
    while (i >= 0) {
        ch = substr(s, i, 1);
        if (ch == "*" || ch == "/" || ch == "%") {
            return i;
        }
        i = i - 1;
    }
    return -1;
}

// Trova l'ultima occorrenza di ^
func find_last_pow(s) {
    i = len(s) - 1;
    while (i >= 0) {
        ch = substr(s, i, 1);
        if (ch == "^") {
            return i;
        }
        i = i - 1;
    }
    return -1;
}

// -----------------------------------------
// PARSER ESPRESSIONI
// -----------------------------------------

func parse_number(s) {
    s = str_trim(s);
    if (len(s) == 0) {
        return 0;
    }
    return float(s);
}

func evaluate(expr) {
    expr = str_trim(expr);
    
    if (len(expr) == 0) {
        return 0;
    }
    
    // Controlla funzioni
    if (str_find(expr, "sqrt(") == 0) {
        inner = substr(expr, 5, len(expr) - 6);
        return radice_quadrata(evaluate(inner));
    }
    if (str_find(expr, "abs(") == 0) {
        inner = substr(expr, 4, len(expr) - 5);
        return valore_assoluto(evaluate(inner));
    }
    if (str_find(expr, "fact(") == 0) {
        inner = substr(expr, 5, len(expr) - 6);
        return fattoriale(int(evaluate(inner)));
    }
    
    // Cerca operatori in ordine di precedenza (bassa prima)
    // Prima + e - (da destra, non all'inizio per gestire numeri negativi)
    pos = find_last_add_sub(expr);
    if (pos > 0) {
        op = substr(expr, pos, 1);
        left = substr(expr, 0, pos);
        right = substr(expr, pos + 1, len(expr) - pos - 1);
        if (op == "+") {
            return evaluate(left) + evaluate(right);
        } else {
            return evaluate(left) - evaluate(right);
        }
    }
    
    // Poi * / %
    pos = find_last_mul_div(expr);
    if (pos >= 0) {
        op = substr(expr, pos, 1);
        left = substr(expr, 0, pos);
        right = substr(expr, pos + 1, len(expr) - pos - 1);
        if (op == "*") {
            return evaluate(left) * evaluate(right);
        } else if (op == "/") {
            divisore = evaluate(right);
            if (divisore == 0) {
                print("Errore: divisione per zero!");
                return 0;
            }
            return evaluate(left) / divisore;
        } else {
            return int(evaluate(left)) % int(evaluate(right));
        }
    }
    
    // Poi ^
    pos = find_last_pow(expr);
    if (pos >= 0) {
        left = substr(expr, 0, pos);
        right = substr(expr, pos + 1, len(expr) - pos - 1);
        return potenza(int(evaluate(left)), int(evaluate(right)));
    }
    
    // Nessun operatore trovato, e' un numero
    return parse_number(expr);
}

// -----------------------------------------
// LOOP PRINCIPALE
// -----------------------------------------

memoria = 0;

print("Memoria inizializzata a 0");
print("Usa 'M' per richiamare memoria, 'MS' per salvare\n");

running = true;
while (running) {
    print("calc> ");
    input_line = read();
    input_line = str_trim(input_line);
    
    if (input_line == "quit" || input_line == "exit") {
        running = false;
        print("Arrivederci!");
    } else if (input_line == "help") {
        print("Operazioni: +, -, *, /, %, ^");
        print("Funzioni: sqrt(n), abs(n), fact(n)");
        print("Memoria: M (richiama), MS (salva ultimo risultato)");
        print("quit - esci");
    } else if (input_line == "M") {
        print("Memoria: " + memoria);
    } else if (input_line == "MS") {
        print("Risultato salvato in memoria");
    } else if (len(input_line) > 0) {
        // Sostituisci M con valore memoria
        if (str_find(input_line, "M") != -1) {
            // Semplificazione: non supportiamo M nell'espressione
            print("(M nelle espressioni non supportato in questa versione)");
        }
        
        risultato = evaluate(input_line);
        print("= " + risultato);
        memoria = risultato;
    }
}

print("\n=== FINE CALCOLATRICE ===");
