// ============================================
// Ascension Example: TCP Sockets
// Client TCP per comunicazione di rete
// ============================================

print("=== TCP SOCKETS ===\n");

// -----------------------------------------
// DNS RESOLUTION
// -----------------------------------------
print("--- DNS Resolution ---");

hostname = "example.com";
print("Risoluzione DNS per: " + hostname);
ip = get_ip(hostname);

if (ip == "") {
    print("Errore: impossibile risolvere hostname");
} else {
    print("IP: " + ip);
}

// -----------------------------------------
// TCP CLIENT - Connessione HTTP manuale
// -----------------------------------------
print("\n--- TCP Client (HTTP manuale) ---");

// Crea socket TCP
sock = socket_open("TCP", "IPv4");

if (sock == NULL) {
    print("Errore: impossibile creare socket");
} else {
    print("Socket creato con ID: ");
    print(sock);
    
    // Connetti al server
    print("Connessione a " + ip + ":80...");
    result = socket_connect(sock, ip, 80);
    
    if (result == NULL) {
        print("Errore: connessione fallita");
    } else {
        print("Connesso!");
        
        // Invia richiesta HTTP
        request = "GET / HTTP/1.1\r\nHost: example.com\r\nConnection: close\r\n\r\n";
        print("Invio richiesta HTTP...");
        sent = socket_send(sock, request);
        print("Bytes inviati: ");
        print(sent);
        
        // Ricevi risposta
        print("Ricezione risposta...");
        response = socket_recv(sock, 1024);
        
        if (response != NULL) {
            print("\n--- Risposta (primi 500 char) ---");
            if (len(response) > 500) {
                print(substr(response, 0, 500));
                print("...");
            } else {
                print(response);
            }
        }
    }
    
    // Chiudi socket
    socket_close(sock);
    print("\nSocket chiuso");
}

// -----------------------------------------
// FUNZIONE HELPER: Simple HTTP Client
// -----------------------------------------
print("\n--- Funzione HTTP via Socket ---");

func http_socket_get(host, path) {
    // Risolvi DNS
    ip_addr = get_ip(host);
    if (ip_addr == "") {
        return NULL;
    }
    
    // Crea e connetti socket
    s = socket_open("TCP", "IPv4");
    if (s == NULL) {
        return NULL;
    }
    
    conn = socket_connect(s, ip_addr, 80);
    if (conn == NULL) {
        socket_close(s);
        return NULL;
    }
    
    // Costruisci e invia richiesta
    req = "GET " + path + " HTTP/1.1\r\n";
    req = req + "Host: " + host + "\r\n";
    req = req + "Connection: close\r\n\r\n";
    
    socket_send(s, req);
    
    // Ricevi risposta
    resp = socket_recv(s, 4096);
    
    // Chiudi socket
    socket_close(s);
    
    return resp;
}

// Test della funzione
result = http_socket_get("example.com", "/");
if (result != NULL) {
    print("HTTP via socket riuscito!");
    print("Ricevuti bytes: ");
    print(len(result));
} else {
    print("Errore nella richiesta");
}

print("\n=== FINE ESEMPIO ===");

// NOTA: Per creare un server TCP, usa:
// server = socket_open("TCP", "IPv4");
// socket_bind(server, "0.0.0.0", 8080);
// socket_listen(server, 5);
// client = socket_accept(server);  // Blocca fino a connessione
// data = socket_recv(client, 1024);
// socket_send(client, "Risposta");
// socket_close(client);
// socket_close(server);
